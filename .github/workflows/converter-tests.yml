name: Converter Tests

on:
  push:
    branches:
      - main
    paths:
      - "runner/converter/**"
      - "runner/package.json"
      - "runner/package-lock.json"
      - ".github/workflows/converter-tests.yml"
  pull_request:
    paths:
      - "runner/converter/**"
      - "runner/package.json"
      - "runner/package-lock.json"
      - ".github/workflows/converter-tests.yml"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: runner/package-lock.json

      - name: Install runner dependencies
        run: |
          cd runner
          npm ci

      - name: Run converter tests
        run: |
          cd runner
          npm test

      - name: Run converter tests with coverage
        run: |
          cd runner
          node --test --experimental-test-coverage converter/converter.test.js

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: runner/package-lock.json

      - name: Install runner dependencies
        run: |
          cd runner
          npm ci

      - name: Check code style
        run: |
          cd runner
          # Check for common issues
          node -e "
            const fs = require('fs');
            const path = require('path');

            const converterFiles = [
              'converter/converter.js',
              'converter/converter.test.js',
              'converter/example.js'
            ];

            let hasErrors = false;

            converterFiles.forEach(file => {
              const content = fs.readFileSync(file, 'utf8');

              // Check for console.log in production code (excluding example.js)
              if (!file.includes('example.js') && !file.includes('.test.js')) {
                if (content.includes('console.log(') || content.includes('console.error(')) {
                  console.error(\`❌ \${file}: Found console.log/console.error\`);
                  hasErrors = true;
                }
              }

              // Check for proper export statements
              if (file.includes('converter.js')) {
                if (!content.includes('export function')) {
                  console.error(\`❌ \${file}: Missing export statements\`);
                  hasErrors = true;
                }
              }

              // Check for proper imports
              if (!content.includes('import')) {
                console.error(\`❌ \${file}: Missing import statements\`);
                hasErrors = true;
              }

              console.log(\`✓ \${file}: Basic checks passed\`);
            });

            if (hasErrors) {
              process.exit(1);
            }
          "

  example:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: runner/package-lock.json

      - name: Install runner dependencies
        run: |
          cd runner
          npm ci

      - name: Run example conversion
        run: |
          cd runner
          node converter/example.js > example-output.yaml

          # Verify output contains expected YAML structure
          if ! grep -q "architecture:" example-output.yaml; then
            echo "❌ Example output missing 'architecture:' key"
            exit 1
          fi

          if ! grep -q "multi_cgra_defaults:" example-output.yaml; then
            echo "❌ Example output missing 'multi_cgra_defaults:' key"
            exit 1
          fi

          if ! grep -q "tile_overrides:" example-output.yaml; then
            echo "❌ Example output missing 'tile_overrides:' key"
            exit 1
          fi

          echo "✓ Example conversion produced valid YAML structure"

      - name: Upload example output
        uses: actions/upload-artifact@v4
        with:
          name: example-conversion-output
          path: runner/example-output.yaml
          retention-days: 7
