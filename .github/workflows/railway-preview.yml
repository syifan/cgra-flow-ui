name: Railway Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    permissions:
      pull-requests: write
    env:
      RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Railway Auth
        run: railway whoami

      - name: Link Railway Project
        run: railway link ${{ secrets.RAILWAY_PROJECT_ID }}

      # Get Supabase branch credentials using the Management API
      - name: Get Supabase Branch Credentials
        id: supabase
        run: |
          apk add --no-cache curl jq

          BRANCH_NAME="${{ github.head_ref }}"
          PROJECT_REF="${{ secrets.SUPABASE_PROJECT_REF }}"

          echo "Looking for Supabase branch: $BRANCH_NAME"

          # List all branches for this project
          BRANCHES=$(curl -s -X GET \
            "https://api.supabase.com/v1/projects/${PROJECT_REF}/branches" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json")

          # Find the branch matching our PR branch name
          BRANCH_INFO=$(echo "$BRANCHES" | jq -r ".[] | select(.git_branch == \"$BRANCH_NAME\")")

          if [ -z "$BRANCH_INFO" ] || [ "$BRANCH_INFO" == "null" ]; then
            echo "::error::No Supabase branch found for '$BRANCH_NAME'. Make sure Supabase GitHub integration is enabled."
            exit 1
          fi

          # Each Supabase branch has its own project_ref
          BRANCH_PROJECT_REF=$(echo "$BRANCH_INFO" | jq -r '.project_ref')
          BRANCH_STATUS=$(echo "$BRANCH_INFO" | jq -r '.status')

          echo "Found branch with project_ref: $BRANCH_PROJECT_REF (status: $BRANCH_STATUS)"

          if [ "$BRANCH_STATUS" != "ACTIVE_HEALTHY" ]; then
            echo "::warning::Branch status is $BRANCH_STATUS, waiting for it to be ready..."
            sleep 30
          fi

          BRANCH_URL="https://${BRANCH_PROJECT_REF}.supabase.co"
          echo "Branch URL: $BRANCH_URL"

          # Get the API keys for this branch
          API_KEYS=$(curl -s -X GET \
            "https://api.supabase.com/v1/projects/${BRANCH_PROJECT_REF}/api-keys" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json")

          ANON_KEY=$(echo "$API_KEYS" | jq -r '.[] | select(.name == "anon") | .api_key')
          SERVICE_ROLE_KEY=$(echo "$API_KEYS" | jq -r '.[] | select(.name == "service_role") | .api_key')

          if [ -z "$ANON_KEY" ] || [ "$ANON_KEY" == "null" ]; then
            echo "::error::Could not retrieve anon key for branch"
            exit 1
          fi

          if [ -z "$SERVICE_ROLE_KEY" ] || [ "$SERVICE_ROLE_KEY" == "null" ]; then
            echo "::error::Could not retrieve service_role key for branch"
            exit 1
          fi

          echo "Successfully retrieved branch credentials"

          echo "::add-mask::$ANON_KEY"
          echo "::add-mask::$SERVICE_ROLE_KEY"

          echo "url=$BRANCH_URL" >> $GITHUB_OUTPUT
          echo "anon_key=$ANON_KEY" >> $GITHUB_OUTPUT
          echo "service_role_key=$SERVICE_ROLE_KEY" >> $GITHUB_OUTPUT

      # Deploy Frontend
      - name: Deploy Frontend
        id: frontend
        run: |
          # Set variables and deploy frontend service
          railway variables --set "VITE_SUPABASE_URL=${{ steps.supabase.outputs.url }}" --service frontend || true
          railway variables --set "VITE_SUPABASE_ANON_KEY=${{ steps.supabase.outputs.anon_key }}" --service frontend || true

          railway up --service frontend --detach

          # Get deployment URL
          FRONTEND_URL=$(railway domain --service frontend 2>/dev/null || echo "pending")
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT

      # Deploy Runner
      - name: Deploy Runner
        working-directory: ./runner
        run: |
          railway variables --set "SUPABASE_URL=${{ steps.supabase.outputs.url }}" --service runner || true
          railway variables --set "SUPABASE_SERVICE_ROLE_KEY=${{ steps.supabase.outputs.service_role_key }}" --service runner || true
          railway variables --set "RUNNER_ID=pr-${{ github.event.pull_request.number }}" --service runner || true
          railway variables --set "POLL_INTERVAL_MS=5000" --service runner || true

          railway up --service runner --detach

      # Comment on PR
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const frontendUrl = '${{ steps.frontend.outputs.frontend_url }}';
            const supabaseUrl = '${{ steps.supabase.outputs.url }}';

            const body = `## ðŸš€ Railway Preview Deployment

            | Service | Status |
            |---------|--------|
            | **Frontend** | ${frontendUrl && frontendUrl !== 'pending' ? `[${frontendUrl}](https://${frontendUrl})` : 'â³ Deploying...'} |
            | **Runner** | âœ… Deployed |
            | **Supabase** | \`${supabaseUrl}\` |

            > This deployment uses the Railway environment configured for this project.
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Railway Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Note: Cleanup is handled automatically by Railway's PR environment feature
  # Enable it in Railway Dashboard â†’ Project Settings â†’ Environments â†’ Enable PR Environments
