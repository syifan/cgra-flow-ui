name: Railway Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

env:
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # Get Supabase branch credentials using the Management API
      # Supabase branches have their own project_ref and API keys
      - name: Get Supabase Branch Credentials
        id: supabase
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          PROJECT_REF="${{ secrets.SUPABASE_PROJECT_REF }}"

          echo "Looking for Supabase branch: $BRANCH_NAME"

          # List all branches for this project
          BRANCHES=$(curl -s -X GET \
            "https://api.supabase.com/v1/projects/${PROJECT_REF}/branches" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json")

          # Find the branch matching our PR branch name
          BRANCH_INFO=$(echo "$BRANCHES" | jq -r ".[] | select(.git_branch == \"$BRANCH_NAME\")")

          if [ -z "$BRANCH_INFO" ] || [ "$BRANCH_INFO" == "null" ]; then
            echo "::error::No Supabase branch found for '$BRANCH_NAME'. Make sure Supabase GitHub integration is enabled."
            exit 1
          fi

          # Each Supabase branch has its own project_ref (different from main project)
          BRANCH_PROJECT_REF=$(echo "$BRANCH_INFO" | jq -r '.project_ref')
          BRANCH_STATUS=$(echo "$BRANCH_INFO" | jq -r '.status')

          echo "Found branch with project_ref: $BRANCH_PROJECT_REF (status: $BRANCH_STATUS)"

          if [ "$BRANCH_STATUS" != "ACTIVE_HEALTHY" ]; then
            echo "::warning::Branch status is $BRANCH_STATUS, waiting for it to be ready..."
            sleep 30
          fi

          # Branch URL uses the branch's own project_ref
          BRANCH_URL="https://${BRANCH_PROJECT_REF}.supabase.co"
          echo "Branch URL: $BRANCH_URL"

          # Get the API keys for this branch (they're per-branch)
          API_KEYS=$(curl -s -X GET \
            "https://api.supabase.com/v1/projects/${BRANCH_PROJECT_REF}/api-keys" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json")

          ANON_KEY=$(echo "$API_KEYS" | jq -r '.[] | select(.name == "anon") | .api_key')
          SERVICE_ROLE_KEY=$(echo "$API_KEYS" | jq -r '.[] | select(.name == "service_role") | .api_key')

          if [ -z "$ANON_KEY" ] || [ "$ANON_KEY" == "null" ]; then
            echo "::error::Could not retrieve anon key for branch"
            exit 1
          fi

          if [ -z "$SERVICE_ROLE_KEY" ] || [ "$SERVICE_ROLE_KEY" == "null" ]; then
            echo "::error::Could not retrieve service_role key for branch"
            exit 1
          fi

          echo "Successfully retrieved branch credentials"

          # Mask sensitive values in logs
          echo "::add-mask::$ANON_KEY"
          echo "::add-mask::$SERVICE_ROLE_KEY"

          echo "url=$BRANCH_URL" >> $GITHUB_OUTPUT
          echo "anon_key=$ANON_KEY" >> $GITHUB_OUTPUT
          echo "service_role_key=$SERVICE_ROLE_KEY" >> $GITHUB_OUTPUT

      # Create Railway environment for this PR
      - name: Create Railway PR Environment
        id: railway_env
        run: |
          ENV_NAME="pr-${{ github.event.pull_request.number }}"
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT

          # Check if environment already exists
          EXISTING=$(railway environment list 2>/dev/null | grep "$ENV_NAME" || true)

          if [ -z "$EXISTING" ]; then
            echo "Creating new environment: $ENV_NAME"
            railway environment create "$ENV_NAME" || true
          else
            echo "Environment $ENV_NAME already exists"
          fi
        env:
          # Account token required to create environments
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}

      # Deploy Frontend to Railway
      - name: Deploy Frontend
        id: frontend
        run: |
          ENV_NAME="pr-${{ github.event.pull_request.number }}"

          # Set environment variables for frontend
          railway variables set \
            VITE_SUPABASE_URL="${{ steps.supabase.outputs.url }}" \
            VITE_SUPABASE_ANON_KEY="${{ steps.supabase.outputs.anon_key }}" \
            --environment "$ENV_NAME" \
            --service frontend || true

          # Deploy frontend
          railway up --environment "$ENV_NAME" --service frontend --detach

          # Get the deployment URL
          FRONTEND_URL=$(railway domain --environment "$ENV_NAME" --service frontend 2>/dev/null || echo "")
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}

      # Deploy Runner to Railway
      - name: Deploy Runner
        id: runner
        working-directory: ./runner
        run: |
          ENV_NAME="pr-${{ github.event.pull_request.number }}"

          # Set environment variables for runner
          railway variables set \
            SUPABASE_URL="${{ steps.supabase.outputs.url }}" \
            SUPABASE_SERVICE_ROLE_KEY="${{ steps.supabase.outputs.service_role_key }}" \
            RUNNER_ID="pr-${{ github.event.pull_request.number }}" \
            POLL_INTERVAL_MS="5000" \
            --environment "$ENV_NAME" \
            --service runner || true

          # Deploy runner
          railway up --environment "$ENV_NAME" --service runner --detach
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}

      # Comment on PR with deployment URLs
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const frontendUrl = '${{ steps.frontend.outputs.frontend_url }}';
            const envName = 'pr-${{ github.event.pull_request.number }}';
            const supabaseUrl = '${{ steps.supabase.outputs.url }}';

            const body = `## ðŸš€ Railway Preview Deployment

            | Service | Status |
            |---------|--------|
            | **Frontend** | ${frontendUrl ? `[${frontendUrl}](https://${frontendUrl})` : 'â³ Deploying...'} |
            | **Runner** | âœ… Running |
            | **Supabase** | \`${supabaseUrl}\` |

            **Environment:** \`${envName}\`

            > Preview will be automatically deleted when PR is closed.
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Railway Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # Cleanup when PR is closed
  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Delete Railway PR Environment
        run: |
          ENV_NAME="pr-${{ github.event.pull_request.number }}"
          echo "Deleting environment: $ENV_NAME"
          railway environment delete "$ENV_NAME" --yes || true
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ðŸ§¹ Railway Preview Cleaned Up

            The preview environment \`pr-${{ github.event.pull_request.number }}\` has been deleted.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
